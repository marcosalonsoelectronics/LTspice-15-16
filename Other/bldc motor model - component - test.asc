Version 4
SHEET 1 3328 1812
WIRE -1424 -736 -1792 -736
WIRE -1152 -736 -1424 -736
WIRE -896 -736 -1152 -736
WIRE -1792 -672 -1792 -736
WIRE -1424 -672 -1424 -736
WIRE -1344 -672 -1424 -672
WIRE -1152 -672 -1152 -736
WIRE -1072 -672 -1152 -672
WIRE -896 -672 -896 -736
WIRE -816 -672 -896 -672
WIRE -1344 -656 -1344 -672
WIRE -1072 -656 -1072 -672
WIRE -816 -656 -816 -672
WIRE -1536 -624 -1552 -624
WIRE -1472 -624 -1536 -624
WIRE -1216 -624 -1264 -624
WIRE -1200 -624 -1216 -624
WIRE -960 -624 -976 -624
WIRE -944 -624 -960 -624
WIRE -1344 -576 -1344 -592
WIRE -1344 -576 -1424 -576
WIRE -1072 -576 -1072 -592
WIRE -1072 -576 -1152 -576
WIRE -816 -576 -816 -592
WIRE -816 -576 -896 -576
WIRE -1792 -544 -1792 -592
WIRE -1424 -544 -1424 -576
WIRE -1376 -544 -1424 -544
WIRE -768 -544 -1376 -544
WIRE 464 -512 288 -512
WIRE 592 -512 544 -512
WIRE 752 -512 672 -512
WIRE 896 -512 784 -512
WIRE 928 -512 896 -512
WIRE 768 -480 768 -496
WIRE 800 -480 768 -480
WIRE 816 -480 800 -480
WIRE 928 -432 928 -512
WIRE 976 -432 928 -432
WIRE 2032 -432 1184 -432
WIRE -1152 -416 -1152 -576
WIRE -1072 -416 -1152 -416
WIRE -1664 -384 -1792 -384
WIRE -1552 -384 -1664 -384
WIRE 464 -384 288 -384
WIRE 592 -384 544 -384
WIRE 752 -384 672 -384
WIRE 896 -384 784 -384
WIRE 976 -384 896 -384
WIRE 2032 -384 1184 -384
WIRE -1792 -352 -1792 -384
WIRE 768 -352 768 -368
WIRE 800 -352 768 -352
WIRE 816 -352 800 -352
WIRE 976 -336 928 -336
WIRE 2032 -336 1184 -336
WIRE -896 -288 -896 -576
WIRE -784 -288 -896 -288
WIRE 1968 -288 1952 -288
WIRE 2032 -288 1968 -288
WIRE -1424 -256 -1424 -544
WIRE -1344 -256 -1424 -256
WIRE -1152 -256 -1152 -416
WIRE -1088 -256 -1152 -256
WIRE -896 -256 -896 -288
WIRE -832 -256 -896 -256
WIRE 464 -256 288 -256
WIRE 592 -256 544 -256
WIRE 752 -256 672 -256
WIRE 896 -256 784 -256
WIRE 928 -256 928 -336
WIRE 928 -256 896 -256
WIRE -1792 -240 -1792 -272
WIRE -1344 -240 -1344 -256
WIRE -1088 -240 -1088 -256
WIRE -832 -240 -832 -256
WIRE 1968 -240 1952 -240
WIRE 2032 -240 1968 -240
WIRE 768 -224 768 -240
WIRE 800 -224 768 -224
WIRE 816 -224 800 -224
WIRE -1520 -208 -1552 -208
WIRE -1472 -208 -1520 -208
WIRE -1232 -208 -1248 -208
WIRE -1200 -208 -1232 -208
WIRE -960 -208 -992 -208
WIRE -944 -208 -960 -208
WIRE 928 -192 896 -192
WIRE 976 -192 976 -288
WIRE 976 -192 928 -192
WIRE 1968 -192 1952 -192
WIRE 2032 -192 1968 -192
WIRE -1344 -160 -1344 -176
WIRE -1344 -160 -1424 -160
WIRE -1088 -160 -1088 -176
WIRE -1088 -160 -1152 -160
WIRE -832 -160 -832 -176
WIRE -832 -160 -896 -160
WIRE -1424 -80 -1424 -160
WIRE -1152 -80 -1152 -160
WIRE -1152 -80 -1424 -80
WIRE -896 -80 -896 -160
WIRE -896 -80 -1152 -80
WIRE 704 -80 672 -80
WIRE 784 -80 704 -80
WIRE 928 -80 848 -80
WIRE 1040 -80 1040 -256
WIRE 1040 -80 928 -80
WIRE 1904 -64 1312 -64
WIRE 2032 -64 1904 -64
WIRE -1152 -16 -1152 -80
WIRE 1312 0 1312 -64
WIRE 1904 0 1904 -64
WIRE 704 112 672 112
WIRE 784 112 704 112
WIRE 1120 112 1120 -256
WIRE 1120 112 848 112
WIRE -1392 144 -1456 144
WIRE -1312 144 -1392 144
WIRE 1312 144 1312 80
WIRE 1904 144 1904 80
WIRE -1376 192 -1424 192
WIRE -1328 192 -1376 192
WIRE 672 224 288 224
WIRE -1344 240 -1392 240
WIRE -1312 240 -1344 240
WIRE 1904 240 1312 240
WIRE 1984 240 1904 240
WIRE -1584 288 -1664 288
WIRE -1552 288 -1584 288
WIRE -1664 304 -1664 288
WIRE 1312 304 1312 240
WIRE 1904 304 1904 240
WIRE -1616 336 -1840 336
WIRE -1584 336 -1584 288
WIRE -1552 336 -1552 288
WIRE -1456 336 -1456 144
WIRE -1424 336 -1424 192
WIRE -1392 336 -1392 240
WIRE -496 416 -528 416
WIRE -432 416 -496 416
WIRE -224 416 -368 416
WIRE -160 416 -224 416
WIRE 112 432 -80 432
WIRE -224 448 -256 448
WIRE -160 448 -224 448
WIRE 1312 448 1312 384
WIRE 1904 448 1904 384
WIRE -400 480 -400 448
WIRE -400 480 -448 480
WIRE -1584 544 -1584 528
WIRE -1296 544 -1584 544
WIRE 112 544 112 432
WIRE -1616 560 -1616 528
WIRE -1296 560 -1616 560
WIRE -496 560 -528 560
WIRE -432 560 -496 560
WIRE -224 560 -368 560
WIRE -160 560 -224 560
WIRE 672 560 672 224
WIRE -1136 576 -1232 576
WIRE -1088 576 -1136 576
WIRE 80 576 -80 576
WIRE 208 576 144 576
WIRE 304 576 208 576
WIRE -224 592 -256 592
WIRE -160 592 -224 592
WIRE 448 592 384 592
WIRE 528 592 448 592
WIRE 640 592 592 592
WIRE 864 592 704 592
WIRE 272 608 240 608
WIRE 304 608 272 608
WIRE 1056 608 944 608
WIRE 1232 608 1120 608
WIRE 1328 608 1296 608
WIRE 1456 608 1408 608
WIRE 1520 608 1456 608
WIRE 1568 608 1520 608
WIRE -1392 624 -1392 528
WIRE -1296 624 -1392 624
WIRE -1088 624 -1088 576
WIRE -992 624 -1088 624
WIRE -880 624 -912 624
WIRE -864 624 -880 624
WIRE 864 624 832 624
WIRE -1424 640 -1424 528
WIRE -1296 640 -1424 640
WIRE -448 640 -448 480
WIRE -400 640 -400 592
WIRE -400 640 -448 640
WIRE -1136 656 -1232 656
WIRE -992 656 -1136 656
WIRE -880 656 -912 656
WIRE -864 656 -880 656
WIRE -992 688 -1088 688
WIRE -880 688 -912 688
WIRE -864 688 -880 688
WIRE 560 688 560 624
WIRE 560 688 480 688
WIRE 832 688 832 624
WIRE 832 688 800 688
WIRE -1392 704 -1392 624
WIRE -1296 704 -1392 704
WIRE -1520 720 -1520 528
WIRE -1296 720 -1520 720
WIRE -992 720 -1072 720
WIRE -880 720 -912 720
WIRE -864 720 -880 720
WIRE 1456 720 1456 608
WIRE 1536 720 1456 720
WIRE 2000 720 1600 720
WIRE -1136 736 -1232 736
WIRE -1088 736 -1088 688
WIRE -1088 736 -1136 736
WIRE -992 752 -1056 752
WIRE -880 752 -912 752
WIRE -864 752 -880 752
WIRE -496 752 -528 752
WIRE -432 752 -496 752
WIRE -224 752 -368 752
WIRE -160 752 -224 752
WIRE 112 768 112 608
WIRE 112 768 -80 768
WIRE -1488 784 -1488 528
WIRE -1296 784 -1488 784
WIRE -992 784 -1040 784
WIRE -880 784 -912 784
WIRE -864 784 -880 784
WIRE -224 784 -256 784
WIRE -160 784 -224 784
WIRE -1616 800 -1616 560
WIRE -1296 800 -1616 800
WIRE -1136 816 -1232 816
WIRE -1072 816 -1072 720
WIRE -1072 816 -1136 816
WIRE 1056 816 960 816
WIRE -496 832 -528 832
WIRE -448 832 -448 640
WIRE -448 832 -496 832
WIRE -400 832 -400 784
WIRE -400 832 -448 832
WIRE 1264 832 1264 640
WIRE 1264 832 1136 832
WIRE 1056 848 1024 848
WIRE -1424 864 -1424 640
WIRE -1296 864 -1424 864
WIRE -1488 880 -1488 784
WIRE -1296 880 -1488 880
WIRE -1136 896 -1232 896
WIRE -1056 896 -1056 752
WIRE -1056 896 -1136 896
WIRE -1520 944 -1520 720
WIRE -1296 944 -1520 944
WIRE -1584 960 -1584 544
WIRE -1296 960 -1584 960
WIRE 240 960 240 608
WIRE 656 960 240 960
WIRE 1024 960 1024 848
WIRE 1024 960 720 960
WIRE 1152 960 1024 960
WIRE 1216 960 1152 960
WIRE -1136 976 -1232 976
WIRE -1040 976 -1040 784
WIRE -1040 976 -1136 976
WIRE -1616 1008 -1616 800
WIRE -1584 1008 -1584 960
WIRE -1552 1008 -1552 528
WIRE -1520 1008 -1520 944
WIRE -1488 1008 -1488 880
WIRE -1456 1008 -1456 528
WIRE -1424 1008 -1424 864
WIRE -1392 1008 -1392 704
WIRE 240 1104 240 960
WIRE 1456 1104 1456 720
WIRE 1456 1104 240 1104
FLAG 2032 -336 hc
IOPIN 2032 -336 Out
FLAG 2032 -384 hb
IOPIN 2032 -384 Out
FLAG 2032 -432 ha
IOPIN 2032 -432 Out
FLAG 928 -80 thetat
FLAG 800 -480 ia
FLAG 800 -352 ib
FLAG 800 -224 ic
FLAG 896 -512 a
FLAG 896 -384 b
FLAG 896 -256 c
FLAG -224 416 ea
FLAG -224 448 ia
FLAG -224 560 eb
FLAG -224 592 ib
FLAG -224 752 ec
FLAG -224 784 ic
FLAG 208 576 Pe
FLAG 448 592 Te
FLAG 288 224 Tload
IOPIN 288 224 In
FLAG 2000 720 wrpm
IOPIN 2000 720 Out
FLAG 928 -192 n
FLAG -496 416 a
FLAG -496 560 b
FLAG -496 752 c
FLAG -496 832 n
FLAG 272 608 w
FLAG 2032 -64 nr
IOPIN 2032 -64 Out
FLAG 1984 240 thetarot
IOPIN 1984 240 Out
FLAG 288 -512 pha
IOPIN 288 -512 In
FLAG 288 -384 phb
IOPIN 288 -384 In
FLAG 288 -256 phc
IOPIN 288 -256 In
FLAG 704 -80 thetarott
FLAG 1152 960 thetarott
FLAG 1520 608 w
FLAG 704 112 w
FLAG 2032 -288 ea
IOPIN 2032 -288 Out
FLAG 2032 -240 eb
IOPIN 2032 -240 Out
FLAG 2032 -192 ec
IOPIN 2032 -192 Out
FLAG 1968 -288 ea
FLAG 1968 -240 eb
FLAG 1968 -192 ec
FLAG 1312 144 0
FLAG 1904 144 0
FLAG 1312 448 0
FLAG 1904 448 0
FLAG -1792 -240 0
FLAG -1664 -384 Tload
FLAG -1152 -16 0
FLAG -1792 -544 0
FLAG -1536 -624 g1
FLAG -1216 -624 g3
FLAG -960 -624 g5
FLAG -1520 -208 g0
FLAG -1232 -208 g2
FLAG -960 -208 g4
FLAG -1376 -544 Pha
FLAG -1072 -416 Phb
FLAG -784 -288 Phc
FLAG -1664 304 0
FLAG -1136 576 g0
FLAG -1136 656 g1
FLAG -1136 736 g2
FLAG -1136 816 g3
FLAG -1136 896 g4
FLAG -1136 976 g5
FLAG -880 624 g0v
FLAG -880 656 g1v
FLAG -880 688 g2v
FLAG -880 720 g3v
FLAG -880 752 g4v
FLAG -880 784 g5v
FLAG -1392 144 ha
FLAG -1376 192 hb
FLAG -1344 240 hc
SYMBOL BLDCM\\bemf 1024 -384 R0
WINDOW 38 57 -55 Bottom 2
SYMATTR InstName U1
SYMBOL ind 576 -496 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName La
SYMATTR Value {L-M}
SYMBOL ind 576 -368 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName Lb
SYMATTR Value {L-M}
SYMBOL ind 576 -240 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName Lc
SYMATTR Value {L-M}
SYMBOL res 560 -528 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName Ra
SYMATTR Value {R}
SYMBOL res 560 -400 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName Rb
SYMATTR Value {R}
SYMBOL res 560 -272 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName Rc
SYMATTR Value {R}
SYMBOL Control\\gain 816 -80 R0
WINDOW 3 2 74 Bottom 2
SYMATTR Value A={pp}
SYMATTR InstName U2
SYMBOL Control\\isense 768 -512 R0
WINDOW 0 -1 -25 Bottom 2
WINDOW 3 48 -6 Bottom 2
SYMATTR InstName Ua
SYMBOL Control\\isense 768 -384 R0
WINDOW 0 -2 -30 Bottom 2
WINDOW 3 45 -11 Bottom 2
SYMATTR InstName Ub
SYMBOL Control\\isense 768 -256 R0
WINDOW 0 -2 -26 Bottom 2
WINDOW 3 46 -7 Bottom 2
SYMATTR InstName Uc
SYMBOL Control\\mul -128 432 R0
SYMATTR InstName U3
SYMBOL Control\\mul -128 576 R0
SYMATTR InstName U4
SYMBOL Control\\mul -128 768 R0
SYMATTR InstName U5
SYMBOL Control\\adder3 112 576 R0
WINDOW 0 35 -27 Bottom 2
SYMATTR InstName U6
SYMBOL Control\\div 336 592 R0
WINDOW 3 -5 67 Bottom 2
SYMATTR InstName U7
SYMBOL Control\\sub2 560 592 R0
SYMATTR InstName U8
SYMBOL Control\\sub2 672 592 M180
SYMATTR InstName U9
SYMBOL Control\\constant 448 688 R0
WINDOW 3 -3 68 Bottom 2
SYMATTR Value K={To}
SYMATTR InstName U10
SYMBOL Control\\div 896 608 R0
WINDOW 3 26 74 Bottom 2
SYMATTR InstName U13
SYMBOL Control\\constant 768 688 R0
WINDOW 3 -2 70 Bottom 2
SYMATTR Value K={J}
SYMATTR InstName U14
SYMBOL Control\\integ 1088 608 R0
WINDOW 3 7 54 Bottom 2
SYMATTR InstName U11
SYMBOL Control\\mul 1088 832 R0
SYMATTR InstName U12
SYMBOL Control\\constant 928 816 R0
WINDOW 3 4 73 Bottom 2
SYMATTR Value K={Bv/J}
SYMATTR InstName U15
SYMBOL Control\\sub2 1264 608 R0
SYMATTR InstName U16
SYMBOL Control\\gain 816 112 R0
WINDOW 3 2 74 Bottom 2
SYMATTR Value A={Kv}
SYMATTR InstName U18
SYMBOL Control\\gain 1568 720 R0
WINDOW 3 2 70 Bottom 2
SYMATTR Value A=60/(2*pi)
SYMATTR InstName U21
SYMBOL Control\\sub2 -400 416 R0
SYMATTR InstName U22
SYMBOL Control\\sub2 -400 560 R0
SYMATTR InstName U23
SYMBOL Control\\sub2 -400 752 R0
SYMATTR InstName U24
SYMBOL Control\\integ 688 960 R0
WINDOW 3 -2 63 Bottom 2
SYMATTR InstName U17
SYMBOL Control\\abs 1360 608 R0
WINDOW 3 0 69 Bottom 2
SYMATTR InstName U29
SYMBOL Misc\\Epoly 1312 -16 R0
WINDOW 3 32 108 Left 2
SYMATTR Value value={ floor( V(thetarott)/(2*pi) )}
SYMATTR InstName E1
SYMBOL res 1888 -16 R0
SYMATTR InstName Rin1
SYMATTR Value 10Meg
SYMBOL Misc\\Epoly 1312 288 R0
WINDOW 3 21 112 Left 2
SYMATTR Value value={ ( V(thetarott)/(2*pi) - V(nr) )*2*pi}
SYMATTR InstName E2
SYMBOL res 1888 288 R0
SYMATTR InstName Rin2
SYMATTR Value 10Meg
SYMBOL voltage -1792 -368 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V1
SYMATTR Value 0.1
SYMBOL Control\\switch -1424 -624 R0
WINDOW 0 -62 -39 Left 2
SYMATTR InstName Us1
SYMBOL Control\\switch -1424 -208 R0
WINDOW 0 -69 -36 Left 2
SYMATTR InstName Us2
SYMBOL Control\\switch -1152 -624 R0
WINDOW 0 -59 -46 Left 2
SYMATTR InstName Us3
SYMBOL Control\\switch -1152 -208 R0
WINDOW 0 -65 -43 Left 2
SYMATTR InstName Us4
SYMBOL Control\\switch -896 -624 R0
WINDOW 0 -66 -45 Left 2
SYMATTR InstName Us5
SYMBOL Control\\switch -896 -208 R0
WINDOW 0 -67 -50 Left 2
SYMATTR InstName Us6
SYMBOL voltage -1792 -688 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName Vdc1
SYMATTR Value 10
SYMBOL Control\\idiode -1328 -592 R180
SYMATTR InstName Ud1
SYMBOL Control\\idiode -1328 -176 R180
SYMATTR InstName Ud2
SYMBOL Control\\idiode -1072 -176 R180
SYMATTR InstName Ud3
SYMBOL Control\\idiode -1056 -592 R180
SYMATTR InstName Ud4
SYMBOL Control\\idiode -800 -592 R180
SYMATTR InstName Ud5
SYMBOL Control\\idiode -816 -176 R180
SYMATTR InstName Ud6
SYMBOL 74HC\\74hc138 -1328 432 R90
SYMATTR InstName U19
SYMBOL Control\\constant -1872 336 R0
WINDOW 3 -5 68 Bottom 2
SYMATTR Value K=5
SYMATTR InstName U20
SYMBOL Digital\\and -1264 496 R0
SYMATTR InstName A1
SYMBOL Digital\\and -1264 576 R0
SYMATTR InstName A2
SYMBOL Digital\\and -1264 656 R0
SYMATTR InstName A3
SYMBOL Digital\\and -1264 736 R0
SYMATTR InstName A4
SYMBOL Digital\\and -1264 816 R0
SYMATTR InstName A5
SYMBOL Digital\\and -1264 896 R0
SYMATTR InstName A6
SYMBOL dview10 -976 768 R0
SYMATTR InstName U25
TEXT 552 -48 Left 2 ;total rotor angle
TEXT 480 136 Left 2 ;angular speed in rad/s
TEXT 2136 -384 Left 2 ;Hall sensor outputs
TEXT 2104 -64 Left 2 ;Total number of rotor revolutions
TEXT 2120 240 Left 2 ;Rotor position angle
TEXT 2104 -240 Left 2 ;Back emfs
TEXT -16 -376 Left 2 ;Motor phases
TEXT 2128 720 Left 2 ;Angular speed in rpm
TEXT -104 -96 Left 5 ;INPUTS
TEXT 2440 112 Left 5 ;OUTPUTS
TEXT -1888 464 Left 2 !.inc 74HC.lib
TEXT -1016 488 Left 2 !.inc dview.lib
TEXT -1976 -888 Left 2 !.tran 0 30m 20m
TEXT -1208 -928 Left 2 !.param R=0.08\n.param L=15u\n.param M=0\n.param pp=6
TEXT -920 -936 Left 2 !.param To=0; N*m\n.param Kv=9.55e-3; V/(rad/s) -> 9.55e-3\n.param Bv=0; N*m*s\n.param J=1e-6; kg*m^2
TEXT -1568 -888 Left 2 !.options reltol=1m
TEXT -1040 -1000 Left 2 ;BM2409-18
